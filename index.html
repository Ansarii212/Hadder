<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تقرير الحضور</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table, th, td {
      border: 1px solid black;
    }
    th, td {
      padding: 8px;
      text-align: center;
    }
    h3 {
      text-align: center;
    }
    /* إضافة تنسيق مخصص للطباعة */
    @media print {
      body * {
        visibility: hidden;
      }
      #reportSection, #reportSection * {
        visibility: visible;
      }
      #reportSection {
        position: absolute;
        top: 0;
        left: 0;
      }
    }
  </style>
</head>
<body>

  <div id="managerPage">
    <!-- نموذج تسجيل المدير (يتم إخفاؤه بعد التسجيل) -->
    <div id="loginForm" style="display:block;">
      <h3>تسجيل دخول المدير</h3>
      <input type="text" id="username" placeholder="اسم المستخدم">
      <input type="password" id="password" placeholder="كلمة المرور">
      <button onclick="loginManager()">تسجيل الدخول</button>
    </div>

    <!-- صفحة التقرير بعد تسجيل المدير -->
    <div id="attendanceReport" style="display:none;">
      <h3>تقرير الحضور</h3>
      <label for="filterDate">اختر التاريخ: </label>
      <input type="date" id="filterDate">
      
      <h3 id="reportTitle" style="display:none;">تقرير الحضور بتاريخ: <span id="selectedDate"></span></h3>
      <button id="printReportBtn" style="display:none;">طباعة التقرير</button>

      <table id="reportTable">
        <thead>
          <tr>
            <th>اسم المعلم</th>
            <th>الحالة</th>
            <th>الوقت</th>
            <th>التاريخ</th>
            <th>الإحداثيات</th>
            <th>المسافة</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <script>
    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUserId = "";

    // تسجيل دخول المدير
    function loginManager() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      if (username === 'admin' && password === 'admin123') {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('attendanceReport').style.display = 'block';
        loadAttendance();
      } else {
        alert("البيانات غير صحيحة");
      }
    }

    // تحميل تقرير الحضور
    function loadAttendance() {
      const filterDate = document.getElementById("filterDate");
      const tableBody = document.getElementById("tableBody");

      filterDate.addEventListener('change', updateTable);

      // دالة التحديث لعرض البيانات بناءً على التاريخ
      const updateTable = () => {
        const selected = filterDate.value;
        if (!selected) {
          document.getElementById("reportTitle").style.display = "none";
          document.getElementById("printReportBtn").style.display = "none";
          tableBody.innerHTML = "";
          return;
        }

        document.getElementById("reportTitle").style.display = "block";
        document.getElementById("selectedDate").innerText = selected;
        document.getElementById("printReportBtn").style.display = "inline-block";

        get(ref(db, "attendance/" + currentUserId)).then(snapshot => {
          tableBody.innerHTML = "";
          snapshot.forEach(child => {
            const data = child.val();
            if (data.date === selected) {
              const row = `
                <tr>
                  <td>${data.teacher}</td>
                  <td>${data.status}</td>
                  <td>${data.time}</td>
                  <td>${data.date}</td>
                  <td>${data.lat.toFixed(5)}, ${data.lng.toFixed(5)}</td>
                  <td>${data.distance} متر</td>
                </tr>
              `;
              tableBody.innerHTML += row;
            }
          });
        });
      };
    }

    // طباعة التقرير
    document.getElementById("printReportBtn").addEventListener("click", () => {
      const originalContent = document.body.innerHTML;
      const reportSection = `
        <div id="reportSection">
          <h3 style="text-align:center;">تقرير الحضور بتاريخ: ${document.getElementById("selectedDate").innerText}</h3>
          ${document.getElementById("reportTable").outerHTML}
        </div>
      `;
      document.body.innerHTML = reportSection;
      window.print();
      document.body.innerHTML = originalContent;
      location.reload(); // لإعادة تحميل الصفحة بعد الطباعة
    });
  </script>

</body>
</html>
