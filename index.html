<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام الحضور</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Amiri', serif;
            background-color: #f2f2f2;
            text-align: center;
        }
        .container {
            width: 80%;
            margin: 0 auto;
        }
        h1 {
            color: #4CAF50;
            margin-top: 50px;
        }
        input, button {
            margin: 10px;
            padding: 10px;
            width: 80%;
            max-width: 400px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        .form-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .hidden {
            display: none;
        }
        .table-container {
            margin-top: 20px;
            padding: 20px;
            background-color: white;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        .logout-button {
            margin-top: 20px;
            background-color: #f44336;
        }
    </style>
</head>
<body>

<div id="registerPage" class="container">
    <h1>تسجيل حساب المدير</h1>
    <div class="form-container">
        <input type="text" id="schoolName" placeholder="اسم المدرسة" required>
        <input type="text" id="schoolPhone" placeholder="رقم هاتف المدرسة" required>
        <input type="password" id="managerPassword" placeholder="كلمة السر للمدير" required>
        <button onclick="registerManager()">تسجيل</button>
    </div>
</div>

<div id="loginPage" class="container hidden">
    <h1>تسجيل الدخول</h1>
    <div class="form-container">
        <input type="text" id="loginPhone" placeholder="رقم الجوال" required>
        <input type="password" id="loginPassword" placeholder="كلمة السر" required>
        <button onclick="login()">دخول</button>
    </div>
</div>

<div id="dashboardPage" class="container hidden">
    <h1 id="schoolNameDisplay">اسم المدرسة</h1>
    <h2>تقرير الحضور</h2>
    <div class="table-container">
        <table id="attendanceTable">
            <thead>
                <tr>
                    <th>اسم المعلم</th>
                    <th>حالة الحضور</th>
                    <th>الوقت</th>
                    <th>تاريخ اليوم</th>
                    <th>الموقع</th>
                    <th>المسافة</th>
                </tr>
            </thead>
            <tbody id="attendanceBody">
            </tbody>
        </table>
    </div>
    <button class="logout-button" onclick="logout()">تسجيل الخروج</button>
    <button onclick="printReport()">طباعة التقرير</button>
    <button onclick="saveAsExcel()">حفظ التقرير كملف Excel</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database.js"></script>
<script>
    // Your Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCr4T8GLRxtf_6LNrokjKvmBOwSkuGO5yQ",
        authDomain: "hamsa-6009e.firebaseapp.com",
        databaseURL: "https://hamsa-6009e-default-rtdb.firebaseio.com",
        projectId: "hamsa-6009e",
        storageBucket: "hamsa-6009e.firebasestorage.app",
        messagingSenderId: "998163671039",
        appId: "1:998163671039:web:d1930ea5b71a3a3fc729ca",
        measurementId: "G-PD1QB8X0FE"
    };
    
    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Register Manager Function
    function registerManager() {
        const schoolName = document.getElementById('schoolName').value;
        const schoolPhone = document.getElementById('schoolPhone').value;
        const managerPassword = document.getElementById('managerPassword').value;

        if (schoolName && schoolPhone && managerPassword) {
            auth.createUserWithEmailAndPassword(schoolPhone + '@school.com', managerPassword)
                .then(userCredential => {
                    const user = userCredential.user;
                    database.ref('managers/' + user.uid).set({
                        schoolName: schoolName,
                        schoolPhone: schoolPhone
                    });
                    showLoginPage();
                })
                .catch(error => alert(error.message));
        } else {
            alert('جميع الحقول مطلوبة');
        }
    }

    // Login Function
    function login() {
        const loginPhone = document.getElementById('loginPhone').value;
        const loginPassword = document.getElementById('loginPassword').value;

        auth.signInWithEmailAndPassword(loginPhone + '@school.com', loginPassword)
            .then(userCredential => {
                const user = userCredential.user;
                loadDashboard(user.uid);
            })
            .catch(error => alert(error.message));
    }

    // Load Dashboard Page
    function loadDashboard(uid) {
        const dashboardPage = document.getElementById('dashboardPage');
        const loginPage = document.getElementById('loginPage');

        database.ref('managers/' + uid).once('value')
            .then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('schoolNameDisplay').textContent = data.schoolName;
                    loadAttendanceReport(uid);
                }
            });

        loginPage.classList.add('hidden');
        dashboardPage.classList.remove('hidden');
    }

    // Logout Function
    function logout() {
        auth.signOut().then(() => {
            const loginPage = document.getElementById('loginPage');
            const dashboardPage = document.getElementById('dashboardPage');
            dashboardPage.classList.add('hidden');
            loginPage.classList.remove('hidden');
        }).catch(error => alert(error.message));
    }

    // Load Attendance Report
    function loadAttendanceReport(uid) {
        const attendanceBody = document.getElementById('attendanceBody');
        database.ref('attendance/' + uid).once('value')
            .then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    attendanceBody.innerHTML = '';
                    for (let key in data) {
                        const record = data[key];
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${record.teacherName}</td>
                            <td>${record.attendanceStatus}</td>
                            <td>${record.time}</td>
                            <td>${record.date}</td>
                            <td>${record.location}</td>
                            <td>${record.distance} متر</td>
                        `;
                        attendanceBody.appendChild(row);
                    }
                }
            });
    }

    // Print Report
    function printReport() {
        window.print();
    }

    // Save Report as Excel
    function saveAsExcel() {
        // Logic to export data as Excel (you might need a library like SheetJS)
    }

    // Show Login Page
    function showLoginPage() {
        const registerPage = document.getElementById('registerPage');
        const loginPage = document.getElementById('loginPage');
        registerPage.classList.add('hidden');
        loginPage.classList.remove('hidden');
    }
</script>

</body>
</html>
