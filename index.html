<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق إدارة الحضور</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsPDF/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; direction: rtl; text-align: right; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: right; }
        button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        #attendanceReport { margin-top: 20px; }
    </style>
</head>
<body>

<h2>إدارة الحضور</h2>

<!-- نموذج إضافة معلم -->
<h3>إضافة معلم جديد</h3>
<form id="teacherForm">
    <label for="teacherName">اسم المعلم:</label>
    <input type="text" id="teacherName" required><br><br>
    <label for="teacherPhone">رقم الهاتف:</label>
    <input type="text" id="teacherPhone" required><br><br>
    <button type="submit">إضافة معلم</button>
</form>

<hr>

<!-- نموذج تسجيل الحضور -->
<h3>تسجيل الحضور</h3>
<form id="attendanceForm">
    <label for="teacherSelect">اختر المعلم:</label>
    <select id="teacherSelect" required></select><br><br>
    <button type="button" onclick="recordAttendance()">تحضير الآن</button>
</form>

<hr>

<!-- تقرير الحضور -->
<h3>تقرير الحضور</h3>
<div id="attendanceReport">يتم تحميل التقرير...</div>

<!-- تصفية الحضور حسب التاريخ أو المعلم -->
<h3>تصفية الحضور</h3>
<form id="filterForm">
    <label for="filterTeacher">اختر المعلم:</label>
    <select id="filterTeacher"></select><br><br>
    <label for="filterDate">اختر التاريخ:</label>
    <input type="date" id="filterDate"><br><br>
    <button type="button" onclick="filterAttendance()">تصفية</button>
</form>

<script>
    // إعداد Firebase
    const firebaseConfig = {
        apiKey: "your-api-key",
        authDomain: "your-auth-domain",
        databaseURL: "https://your-database-url.firebaseio.com",
        projectId: "your-project-id",
        storageBucket: "your-storage-bucket",
        messagingSenderId: "your-sender-id",
        appId: "your-app-id"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database(app);

    // تحميل المعلمين إلى القائمة المنسدلة
    function loadTeachers() {
        const teachersRef = firebase.database().ref('teachers');
        teachersRef.once('value', (snapshot) => {
            const teachers = snapshot.val();
            const teacherSelect = document.getElementById("teacherSelect");
            const filterTeacher = document.getElementById("filterTeacher");
            teacherSelect.innerHTML = '';
            filterTeacher.innerHTML = '';
            for (let key in teachers) {
                const option = document.createElement("option");
                option.value = key;
                option.textContent = teachers[key].name;
                teacherSelect.appendChild(option);

                const filterOption = document.createElement("option");
                filterOption.value = key;
                filterOption.textContent = teachers[key].name;
                filterTeacher.appendChild(filterOption);
            }
        });
    }

    // إضافة معلم جديد
    document.getElementById('teacherForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const teacherName = document.getElementById('teacherName').value;
        const teacherPhone = document.getElementById('teacherPhone').value;
        const newTeacherRef = firebase.database().ref('teachers').push();
        newTeacherRef.set({
            name: teacherName,
            phone: teacherPhone
        }).then(() => {
            alert("تم إضافة المعلم بنجاح!");
            loadTeachers();
        });
    });

    // تسجيل الحضور
    function recordAttendance() {
        const teacherId = document.getElementById('teacherSelect').value;
        const teacherRef = firebase.database().ref('teachers/' + teacherId);
        teacherRef.once('value', (snapshot) => {
            const teacherName = snapshot.val().name;
            const date = new Date().toLocaleDateString();
            const time = new Date().toLocaleTimeString();
            const location = "الموقع الجغرافي هنا"; // يجب الحصول على الموقع الفعلي باستخدام API
            const attendanceRef = firebase.database().ref('attendance').push();
            attendanceRef.set({
                teacherName: teacherName,
                date: date,
                time: time,
                location: location
            }).then(() => {
                alert("تم تسجيل الحضور بنجاح!");
            });
        });
    }

    // تحميل تقرير الحضور
    function loadAttendance() {
        const attendanceRef = firebase.database().ref('attendance');
        attendanceRef.once('value', (snapshot) => {
            const data = snapshot.val();
            let report = '';
            for (let key in data) {
                report += `معلم: ${data[key].teacherName}\n`;
                report += `تاريخ: ${data[key].date}\n`;
                report += `موقع: ${data[key].location}\n`;
                report += `الوقت: ${data[key].time}\n\n`;
            }
            document.getElementById('attendanceReport').innerText = report;
        });
    }

    // تصفية الحضور
    function filterAttendance() {
        const teacherId = document.getElementById('filterTeacher').value;
        const date = document.getElementById('filterDate').value;
        const attendanceRef = firebase.database().ref('attendance');
        let query = attendanceRef;
        if (teacherId) {
            query = query.orderByChild('teacherName').equalTo(teacherId);
        }
        if (date) {
            query = query.orderByChild('date').equalTo(date);
        }
        query.once('value', (snapshot) => {
            const data = snapshot.val();
            let report = '';
            for (let key in data) {
                report += `معلم: ${data[key].teacherName}\n`;
                report += `تاريخ: ${data[key].date}\n`;
                report += `موقع: ${data[key].location}\n`;
                report += `الوقت: ${data[key].time}\n\n`;
            }
            document.getElementById('attendanceReport').innerText = report;
        });
    }

    // توليد تقرير PDF
    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const content = document.getElementById('attendanceReport').innerText;
        doc.text(content, 10, 10);
        doc.save('attendance_report.pdf');
    }

    // تحميل المعلمين عند تحميل الصفحة
    loadTeachers();
    loadAttendance();
</script>

</body>
</html>
